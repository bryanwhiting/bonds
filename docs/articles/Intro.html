<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview • bonds</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Overview">
<meta property="og:description" content="bonds">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bonds</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Intro.html">Overview</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Intro_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview</h1>
            
      
      
      <div class="hidden name"><code>Intro.Rmd</code></div>

    </div>

    
    
<div id="problem-statement" class="section level2">
<h2 class="hasAnchor">
<a href="#problem-statement" class="anchor"></a>Problem statement</h2>
<blockquote>
<p>Assume that there is a data science team working on developing a classification algorithm that at a Bond Object level can predict <code>PULL_TEST_STATUS</code> based on the time-series data in the Sample Objects. It is currently a very time-consuming task for this team to access the data they need. These JSON files land in a single directory on a Network File Share (NFS) and there are tens of thousands of files generated per day. Thus, this team can only get data for a specific <code>BOND_GROUP_ID</code>, for example, by loading data for a particular time range into memory and then filtering. They are looking to you to help provide a new way to access this data in a schema which facilitates their modeling efforts.</p>
</blockquote>
</div>
<div id="problem-break-down" class="section level2">
<h2 class="hasAnchor">
<a href="#problem-break-down" class="anchor"></a>Problem break down</h2>
<div id="bdd-scenario" class="section level3">
<h3 class="hasAnchor">
<a href="#bdd-scenario" class="anchor"></a>BDD Scenario</h3>
<p>As a data engineer, I want to make it as easy as possible for the data science team to query data by timestamp for a given bond_group_id so they can predict the failure of pull_test_status given sample data and anticipate, identify, and eliminate failures.</p>
</div>
<div id="interpretation" class="section level3">
<h3 class="hasAnchor">
<a href="#interpretation" class="anchor"></a>Interpretation</h3>
<p>Inputs:</p>
<ul>
<li>Time series data (very important for modeling)</li>
<li>Assume 100k json files per day (time/scale constraint)
<ul>
<li>About 1.5TB of data per day if we have ~15MB per file</li>
<li>About 1.15 files per second if <span class="math inline">\((100k/(24*60*60))\)</span>
</li>
</ul>
</li>
<li>JSON files in single directory</li>
</ul>
<p>Constraints:</p>
<ul>
<li>Linux cluster (no cloud resources)</li>
<li>Access to shared file system</li>
</ul>
<p>Requirements:</p>
<ul>
<li>Get all trace_samples for a bond_group_id</li>
<li>Dead simple to query data for modeling</li>
</ul>
</div>
<div id="schema" class="section level3">
<h3 class="hasAnchor">
<a href="#schema" class="anchor"></a>Schema</h3>
<p>A few ideas come to mind for how we’ll store the data:</p>
<ul>
<li>Use a (<a href="https://searchdatamanagement.techtarget.com/definition/star-schema">star schema</a> design)</li>
<li>Save out data in the way the users will query it (bond_group_id and samples)</li>
</ul>
<p><strong>Star Schema</strong>: Since our data are nested, we can create dimension tables for files and fact tables for bonds and samples.</p>
<pre><code>files_table
- file_id
- file_* (metadata)

bonds_table 
- file_id
- bond_id
- bond_* (metadata)

samples_table:
- (optional): file_id // optional bc each sample_id is unique to bond_id
- bond_id
- sample_id
- sample_* (metadata)</code></pre>
<p>Cons: Users would have to join the data to do their analysis. Joins can be messy (especially with time-series data).</p>
<p><strong>Model-ready dataset</strong>: Prepare it for modeling (flat tables):</p>
<pre><code>samples_table:
sample_id 
bond_id
bond_metadata* (replicated each row per sample_id)
file_id
file_metadata (replicated each row per bond_id)</code></pre>
<p>Flat tables are easiest for doing machine learning. They’re inefficient for storage, however.</p>
<p><strong>Other ideas:</strong></p>
<ul>
<li>Nested arrays (multidimensional fields within a table). This is too complicated for this assignment.</li>
<li>Snowflake schema: also too complex, but might be efficient for storage</li>
</ul>
</div>
<div id="data-storage" class="section level3">
<h3 class="hasAnchor">
<a href="#data-storage" class="anchor"></a>Data Storage</h3>
<p>A few storage approaches come to mind:</p>
<ul>
<li>Save in a database (sqlite)</li>
<li>Save as parquet files</li>
<li>Save as avro</li>
<li>Save as other data formats (R/Python native)</li>
</ul>
<p><strong>Pros/cons of database</strong></p>
<p>Pros:</p>
<ul>
<li>Database is easy to query with SQL.</li>
<li>Database can handle file writing concurrency.</li>
<li>Quick I/O.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Database might have slower I/O than parquet</li>
<li>Problems querying terabytes of data on a daily basis.</li>
<li>Would also have problems maintaining the size over time. We could design the database to be indexed on time and bond_group_id, but this doesn’t guarantee it’ll be fast to query. If users try to do joins against the database, we’d have to help optimize the queries.</li>
<li>Less flexible if each json file has unique columns (benefits of json file format is that engineers can easily add/subtract key-value pairs. it’s very flexible. But the database might not be so flexible)</li>
</ul>
<p><strong>Pros/cons of parquet files</strong></p>
<p>Pros:</p>
<ul>
<li>Individual file types are saved out.</li>
<li>No collisions since you’re just loading json files and converting them to parquet files.</li>
<li>Users can easily load in the files that they want (e.g., you can name files in a way to make it easy to read by date), thus the I/O is incredibly fast since the users wouldn’t have to load the data into memory first before filtering.</li>
<li>Users can use any language they want to query (java, scala, python, pyspark, pandas, dask, R, RSpark).</li>
</ul>
<p>Cons:</p>
<ul>
<li>Users might not be as familiar with parquet and we’d have to teach them its benefits (not hard to do!).</li>
</ul>
<p><strong>Pros/cons of avro</strong>: similar to parquet, but more easily handles file systems which <a href="http://avro.apache.org/docs/1.7.7/spec.html#Schema+Resolution">change schema over time</a>.</p>
<p><strong>Pros/cons of language-native file systems</strong></p>
<p>Pros:</p>
<ul>
<li>R has incredibly fast IO with <code>.Rda</code>, <code>.RDS</code> and <code>.fst</code> file types (see <a href="https://data.nozav.org/post/2019-r-data-frame-benchmark/">post</a>). That, and the data is efficiently stored if it’s going to be used specifically by R users.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Users would be constrained to one language for I/O and would have to convert from R to python (or vice versa).</li>
</ul>
</div>
</div>
<div id="r-package" class="section level2">
<h2 class="hasAnchor">
<a href="#r-package" class="anchor"></a>R Package</h2>
<div id="etl-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#etl-the-data" class="anchor"></a>ETL the Data</h3>
<p>I’ve decided to design using a few different design approaches (reviewed below). I wrote an R package to handle the data processing. The <code>bonds</code> package has multiple functions to help with ETL.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bonds</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: arrow</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'arrow'</span>
<span class="co">#&gt; The following object is masked from 'package:utils':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     timestamp</span>
<span class="co">#&gt; Loading required package: DBI</span>
<span class="co">#&gt; Loading required package: dplyr</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="co">#&gt; Loading required package: fs</span>
<span class="co">#&gt; Loading required package: glue</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'glue'</span>
<span class="co">#&gt; The following object is masked from 'package:dplyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     collapse</span>
<span class="co">#&gt; Loading required package: logger</span>
<span class="co">#&gt; Loading required package: stringr</span>
<span class="co">#&gt; Loading required package: jsonlite</span>
<span class="co">#&gt; Loading required package: tidyjson</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'tidyjson'</span>
<span class="co">#&gt; The following object is masked from 'package:jsonlite':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     read_json</span>
<span class="co">#&gt; Loading required package: tidyr</span>
<span class="co">#&gt; Loading required package: tictoc</span>
<span class="co">#&gt; Loading required package: RSQLite</span>
<span class="co">#&gt; Loading required package: pool</span>
<span class="co">#&gt; Loading required package: here</span>
<span class="co">#&gt; here() starts at /home/rstudio/tesla/bonds</span></code></pre></div>
<p>I created a function <code><a href="../reference/etl_all_files.html">etl_all_files()</a></code> that does the ELT:</p>
<ol style="list-style-type: decimal">
<li>reads the json</li>
<li>cleans data</li>
<li>loads it into a sqlite database</li>
<li>saves out two types of parquet files (which will be reviewed later).</li>
</ol>
<p>Here are the logs for the output:</p>
<pre><code>&gt; etl_all_files()
[1] 1
INFO [2021-10-29 05:14:41] Parsing JSON
INFO [2021-10-29 05:14:44] Cleaning data
INFO [2021-10-29 05:14:45] Loading to sql
0.812 sec elapsed
INFO [2021-10-29 05:14:45] Save as pqt all
0.359 sec elapsed
INFO [2021-10-29 05:14:46] Save as pqt by group_id
0.426 sec elapsed
INFO [2021-10-29 05:14:46] Finished file1
[1] 2
INFO [2021-10-29 05:14:46] Parsing JSON
INFO [2021-10-29 05:14:49] Cleaning data
INFO [2021-10-29 05:14:49] Loading to sql
INFO [2021-10-29 05:14:49] Updating [data.files] from file 2
INFO [2021-10-29 05:14:49] Updating [data.bonds] from file 2
INFO [2021-10-29 05:14:49] Updating [data.samples] from file 2
0.5 sec elapsed
INFO [2021-10-29 05:14:50] Save as pqt all
0.2 sec elapsed
INFO [2021-10-29 05:14:50] Save as pqt by group_id
0.942 sec elapsed
INFO [2021-10-29 05:14:51] Finished file2</code></pre>
<details><summary>
Click for more logs
</summary><pre><code>[1] 3
INFO [2021-10-29 05:14:51] Parsing JSON
INFO [2021-10-29 05:14:54] Cleaning data
INFO [2021-10-29 05:14:54] Loading to sql
INFO [2021-10-29 05:14:54] Updating [data.files] from file 3
INFO [2021-10-29 05:14:54] Adding rework_trigger_msg AS TEXT to [data.bonds]
INFO [2021-10-29 05:14:54] Updating [data.bonds] from file 3
INFO [2021-10-29 05:14:54] Updating [data.samples] from file 3
0.522 sec elapsed
INFO [2021-10-29 05:14:55] Save as pqt all
0.191 sec elapsed
INFO [2021-10-29 05:14:55] Save as pqt by group_id
0.469 sec elapsed
INFO [2021-10-29 05:14:55] Finished file3
[1] 4
INFO [2021-10-29 05:14:55] Parsing JSON
INFO [2021-10-29 05:14:59] Cleaning data
INFO [2021-10-29 05:14:59] Loading to sql
INFO [2021-10-29 05:14:59] Updating [data.files] from file 4
INFO [2021-10-29 05:14:59] Updating [data.bonds] from file 4
INFO [2021-10-29 05:14:59] Updating [data.samples] from file 4
0.659 sec elapsed
INFO [2021-10-29 05:15:00] Save as pqt all
0.26 sec elapsed
INFO [2021-10-29 05:15:00] Save as pqt by group_id
0.536 sec elapsed
INFO [2021-10-29 05:15:01] Finished file4
[1] 5
INFO [2021-10-29 05:15:01] Parsing JSON
INFO [2021-10-29 05:15:04] Cleaning data
INFO [2021-10-29 05:15:04] Loading to sql
INFO [2021-10-29 05:15:04] Updating [data.files] from file 5
INFO [2021-10-29 05:15:04] Updating [data.bonds] from file 5
INFO [2021-10-29 05:15:04] Updating [data.samples] from file 5
0.385 sec elapsed
INFO [2021-10-29 05:15:04] Save as pqt all
0.123 sec elapsed
INFO [2021-10-29 05:15:04] Save as pqt by group_id
0.572 sec elapsed
INFO [2021-10-29 05:15:05] Finished file5
[1] 6
INFO [2021-10-29 05:15:05] Parsing JSON
INFO [2021-10-29 05:15:07] Cleaning data
INFO [2021-10-29 05:15:08] Loading to sql
INFO [2021-10-29 05:15:08] Updating [data.files] from file 6
INFO [2021-10-29 05:15:08] Updating [data.bonds] from file 6
INFO [2021-10-29 05:15:08] Updating [data.samples] from file 6
0.489 sec elapsed
INFO [2021-10-29 05:15:08] Save as pqt all
0.128 sec elapsed
INFO [2021-10-29 05:15:09] Save as pqt by group_id
0.412 sec elapsed
INFO [2021-10-29 05:15:09] Finished file6
[1] 7
INFO [2021-10-29 05:15:09] Parsing JSON
INFO [2021-10-29 05:15:11] Cleaning data
INFO [2021-10-29 05:15:11] Loading to sql
INFO [2021-10-29 05:15:11] Updating [data.files] from file 7
INFO [2021-10-29 05:15:11] Updating [data.bonds] from file 7
INFO [2021-10-29 05:15:11] Updating [data.samples] from file 7
0.355 sec elapsed
INFO [2021-10-29 05:15:12] Save as pqt all
0.098 sec elapsed
INFO [2021-10-29 05:15:12] Save as pqt by group_id
0.411 sec elapsed
INFO [2021-10-29 05:15:12] Finished file7
[1] 8
INFO [2021-10-29 05:15:12] Parsing JSON
INFO [2021-10-29 05:15:15] Cleaning data
INFO [2021-10-29 05:15:15] Loading to sql
INFO [2021-10-29 05:15:15] Updating [data.files] from file 8
INFO [2021-10-29 05:15:15] Updating [data.bonds] from file 8
INFO [2021-10-29 05:15:15] Updating [data.samples] from file 8
0.367 sec elapsed
INFO [2021-10-29 05:15:16] Save as pqt all
0.107 sec elapsed
INFO [2021-10-29 05:15:16] Save as pqt by group_id
0.47 sec elapsed
INFO [2021-10-29 05:15:16] Finished file8
[1] 9
INFO [2021-10-29 05:15:16] Parsing JSON
INFO [2021-10-29 05:15:20] Cleaning data
INFO [2021-10-29 05:15:20] Loading to sql
INFO [2021-10-29 05:15:20] Updating [data.files] from file 9
INFO [2021-10-29 05:15:20] Updating [data.bonds] from file 9
INFO [2021-10-29 05:15:20] Updating [data.samples] from file 9
0.462 sec elapsed
INFO [2021-10-29 05:15:20] Save as pqt all
0.206 sec elapsed
INFO [2021-10-29 05:15:21] Save as pqt by group_id
0.501 sec elapsed
INFO [2021-10-29 05:15:21] Finished file9
[1] 10
INFO [2021-10-29 05:15:21] Parsing JSON
INFO [2021-10-29 05:15:24] Cleaning data
INFO [2021-10-29 05:15:24] Loading to sql
INFO [2021-10-29 05:15:24] Updating [data.files] from file 10
INFO [2021-10-29 05:15:24] Updating [data.bonds] from file 10
INFO [2021-10-29 05:15:24] Updating [data.samples] from file 10
0.52 sec elapsed
INFO [2021-10-29 05:15:25] Save as pqt all
0.21 sec elapsed
INFO [2021-10-29 05:15:25] Save as pqt by group_id
0.469 sec elapsed
INFO [2021-10-29 05:15:25] Finished file10
[1] 11
INFO [2021-10-29 05:15:25] Parsing JSON
INFO [2021-10-29 05:15:28] Cleaning data
INFO [2021-10-29 05:15:28] Loading to sql
INFO [2021-10-29 05:15:28] Updating [data.files] from file 11
INFO [2021-10-29 05:15:28] Updating [data.bonds] from file 11
INFO [2021-10-29 05:15:28] Updating [data.samples] from file 11
0.409 sec elapsed
INFO [2021-10-29 05:15:29] Save as pqt all
0.21 sec elapsed
INFO [2021-10-29 05:15:29] Save as pqt by group_id
0.571 sec elapsed
INFO [2021-10-29 05:15:30] Finished file11
[1] 12
INFO [2021-10-29 05:15:30] Parsing JSON
INFO [2021-10-29 05:15:32] Cleaning data
INFO [2021-10-29 05:15:32] Loading to sql
INFO [2021-10-29 05:15:32] Updating [data.files] from file 12
INFO [2021-10-29 05:15:32] Updating [data.bonds] from file 12
INFO [2021-10-29 05:15:32] Updating [data.samples] from file 12
0.328 sec elapsed
INFO [2021-10-29 05:15:33] Save as pqt all
0.099 sec elapsed
INFO [2021-10-29 05:15:33] Save as pqt by group_id
0.447 sec elapsed
INFO [2021-10-29 05:15:33] Finished file12
[1] 13
INFO [2021-10-29 05:15:33] Parsing JSON
INFO [2021-10-29 05:15:37] Cleaning data
INFO [2021-10-29 05:15:37] Loading to sql
INFO [2021-10-29 05:15:37] Updating [data.files] from file 13
INFO [2021-10-29 05:15:37] Updating [data.bonds] from file 13
INFO [2021-10-29 05:15:37] Updating [data.samples] from file 13
0.476 sec elapsed
INFO [2021-10-29 05:15:37] Save as pqt all
0.144 sec elapsed
INFO [2021-10-29 05:15:37] Save as pqt by group_id
0.361 sec elapsed
INFO [2021-10-29 05:15:38] Finished file13
[1] 14
INFO [2021-10-29 05:15:38] Parsing JSON
INFO [2021-10-29 05:15:41] Cleaning data
INFO [2021-10-29 05:15:42] Loading to sql
INFO [2021-10-29 05:15:42] Updating [data.files] from file 14
INFO [2021-10-29 05:15:42] Updating [data.bonds] from file 14
INFO [2021-10-29 05:15:42] Updating [data.samples] from file 14
0.539 sec elapsed
INFO [2021-10-29 05:15:42] Save as pqt all
0.114 sec elapsed
INFO [2021-10-29 05:15:42] Save as pqt by group_id
0.69 sec elapsed
INFO [2021-10-29 05:15:43] Finished file14
[1] 15
INFO [2021-10-29 05:15:43] Parsing JSON
INFO [2021-10-29 05:15:46] Cleaning data
INFO [2021-10-29 05:15:46] Loading to sql
INFO [2021-10-29 05:15:46] Updating [data.files] from file 15
INFO [2021-10-29 05:15:46] Updating [data.bonds] from file 15
INFO [2021-10-29 05:15:46] Updating [data.samples] from file 15
0.374 sec elapsed
INFO [2021-10-29 05:15:47] Save as pqt all
0.113 sec elapsed
INFO [2021-10-29 05:15:47] Save as pqt by group_id
0.399 sec elapsed
INFO [2021-10-29 05:15:47] Finished file15</code></pre>
</details>
</div>
<div id="conclusions" class="section level3">
<h3 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h3>
<p><code>sqlite</code> is 3x slower than writing out by parquet. Saving out parquet files by group_id is 3x slower than doing the star schema approach.</p>
</div>
</div>
<div id="interact-with-schema" class="section level2">
<h2 class="hasAnchor">
<a href="#interact-with-schema" class="anchor"></a>Interact with Schema</h2>
<p>There are two schemas:</p>
<ol style="list-style-type: decimal">
<li>star schema of a <code>files</code>, <code>bonds</code>, and <code>samples</code> table. This is saved out as both sqlite and parquet</li>
<li>a model-ready dataset, where <code>bonds</code> is joined to <code>samples</code>
</li>
</ol>
<div id="read-in-output" class="section level3">
<h3 class="hasAnchor">
<a href="#read-in-output" class="anchor"></a>Read in output</h3>
<p>Set up SQL connection for star schema:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">db_path</span> <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">'output/data.db'</span><span class="op">)</span>
<span class="co"># pool &lt;- dbPool(RSQLite::SQLite(), db=db_path)</span>
<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, db<span class="op">=</span><span class="va">db_path</span><span class="op">)</span></code></pre></div>
<p>Explore schema of tables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">con</span>, <span class="st">'PRAGMA table_info(files)'</span><span class="op">)</span>
<span class="co">#&gt;   cid              name    type notnull dflt_value pk</span>
<span class="co">#&gt; 1   0           file_id INTEGER       0         NA  0</span>
<span class="co">#&gt; 2   1   start_date_time    REAL       0         NA  0</span>
<span class="co">#&gt; 3   2 uut_serial_number    TEXT       0         NA  0</span>
<span class="co">#&gt; 4   3        station_id    TEXT       0         NA  0</span>
<span class="co">#&gt; 5   4        bond_count INTEGER       0         NA  0</span>

<span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">con</span>, <span class="st">'PRAGMA table_info(bonds)'</span><span class="op">)</span>
<span class="co">#&gt;    cid               name    type notnull dflt_value pk</span>
<span class="co">#&gt; 1    0            file_id INTEGER       0         NA  0</span>
<span class="co">#&gt; 2    1            bond_id INTEGER       0         NA  0</span>
<span class="co">#&gt; 3    2    process_program    TEXT       0         NA  0</span>
<span class="co">#&gt; 4    3        zone_number INTEGER       0         NA  0</span>
<span class="co">#&gt; 5    4        wire_number INTEGER       0         NA  0</span>
<span class="co">#&gt; 6    5        bond_number INTEGER       0         NA  0</span>
<span class="co">#&gt; 7    6      bond_group_id    TEXT       0         NA  0</span>
<span class="co">#&gt; 8    7          date_time    REAL       0         NA  0</span>
<span class="co">#&gt; 9    8          wire_feed INTEGER       0         NA  0</span>
<span class="co">#&gt; 10   9   pull_test_status    TEXT       0         NA  0</span>
<span class="co">#&gt; 11  10        program_rev    TEXT       0         NA  0</span>
<span class="co">#&gt; 12  11        cell_id_mod    TEXT       0         NA  0</span>
<span class="co">#&gt; 13  12       brick_id_mod INTEGER       0         NA  0</span>
<span class="co">#&gt; 14  13      cell_polarity    TEXT       0         NA  0</span>
<span class="co">#&gt; 15  14          cp_id_mod    TEXT       0         NA  0</span>
<span class="co">#&gt; 16  15 trace_sample_count INTEGER       0         NA  0</span>
<span class="co">#&gt; 17  16 rework_trigger_msg    TEXT       0         NA  0</span>

<span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">con</span>, <span class="st">'PRAGMA table_info(samples)'</span><span class="op">)</span>
<span class="co">#&gt;    cid    name    type notnull dflt_value pk</span>
<span class="co">#&gt; 1    0 file_id INTEGER       0         NA  0</span>
<span class="co">#&gt; 2    1 bond_id INTEGER       0         NA  0</span>
<span class="co">#&gt; 3    2  sample INTEGER       0         NA  0</span>
<span class="co">#&gt; 4    3    dfrm    REAL       0         NA  0</span>
<span class="co">#&gt; 5    4    driv INTEGER       0         NA  0</span>
<span class="co">#&gt; 6    5    freq    REAL       0         NA  0</span>
<span class="co">#&gt; 7    6    phas    REAL       0         NA  0</span>
<span class="co">#&gt; 8    7      us INTEGER       0         NA  0</span>
<span class="co">#&gt; 9    8    volt INTEGER       0         NA  0</span>
<span class="co">#&gt; 10   9   alcpt    REAL       0         NA  0</span></code></pre></div>
<p>You can write SQL to read the data directly:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> files</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">limit</span> <span class="dv">10</span></span></code></pre></div>
<div class="knitsql-table">
<table class="table">
<caption>Displaying records 1 - 10</caption>
<thead><tr class="header">
<th align="left">file_id</th>
<th align="right">start_date_time</th>
<th align="left">uut_serial_number</th>
<th align="left">station_id</th>
<th align="right">bond_count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">1452089076</td>
<td align="left">097192</td>
<td align="left">M364110709</td>
<td align="right">888</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">1452227457</td>
<td align="left">103118</td>
<td align="left">M364111210</td>
<td align="right">888</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">1453450925</td>
<td align="left">145928</td>
<td align="left">M364111202</td>
<td align="right">888</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">1452404389</td>
<td align="left">108025</td>
<td align="left">M364111210</td>
<td align="right">888</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">1452100148</td>
<td align="left">097231</td>
<td align="left">M364111107</td>
<td align="right">888</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">1453361125</td>
<td align="left">144167</td>
<td align="left">M364120804</td>
<td align="right">888</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">1452534748</td>
<td align="left">103279</td>
<td align="left">AST215060003</td>
<td align="right">888</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">1452539268</td>
<td align="left">111696</td>
<td align="left">M362100702</td>
<td align="right">888</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">1453295399</td>
<td align="left">143550</td>
<td align="left">M364111205</td>
<td align="right">888</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">1452120372</td>
<td align="left">097298</td>
<td align="left">M364111205</td>
<td align="right">888</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="parquet-star-schema" class="section level3">
<h3 class="hasAnchor">
<a href="#parquet-star-schema" class="anchor"></a>Parquet Star Schema</h3>
<p>I saved the star schema out as a parquet files, one parquet file per file_id. There are 15 files per <code>bonds/</code>, <code>files/</code> and <code>samples/</code> folders.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dir_output</span> <span class="op">&lt;-</span> <span class="st">"/home/rstudio/tesla/bonds/output"</span>
<span class="va">dir_pqt</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">dir_output</span>, <span class="st">"pqt"</span><span class="op">)</span>
<span class="va">dir_pqt_all</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">dir_pqt</span>, <span class="st">"all"</span><span class="op">)</span>
<span class="va">dir_pqt_grpid</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">dir_pqt</span>, <span class="st">"grpid"</span><span class="op">)</span>
<span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">dir_pqt_all</span><span class="op">)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/bonds</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/samples</span></code></pre></div>
<p>Inspecting the <code>files</code> folder:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/path.html">path</a></span><span class="op">(</span><span class="va">dir_pqt_all</span>, <span class="st">'files'</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00001.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00002.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00003.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00004.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00005.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00006.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00007.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00008.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00009.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00010.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00011.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00012.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00013.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00014.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/all/files/part-00015.parquet</span></code></pre></div>
<p>I wrote a function to read the parquet files:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span><span class="va">dir_pqt_all</span>, <span class="st">'files'</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 15 × 5</span>
<span class="co">#&gt;    file_id start_date_time     uut_serial_number station_id   bond_count</span>
<span class="co">#&gt;      &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;             &lt;chr&gt;             &lt;int&gt;</span>
<span class="co">#&gt;  1       1 2016-01-06 14:04:36 097192            M364110709          888</span>
<span class="co">#&gt;  2       2 2016-01-08 04:30:57 103118            M364111210          888</span>
<span class="co">#&gt;  3       3 2016-01-22 08:22:05 145928            M364111202          888</span>
<span class="co">#&gt;  4       4 2016-01-10 05:39:49 108025            M364111210          888</span>
<span class="co">#&gt;  5       5 2016-01-06 17:09:08 097231            M364111107          888</span>
<span class="co">#&gt;  6       6 2016-01-21 07:25:25 144167            M364120804          888</span>
<span class="co">#&gt;  7       7 2016-01-11 17:52:28 103279            AST215060003        888</span>
<span class="co">#&gt;  8       8 2016-01-11 19:07:48 111696            M362100702          888</span>
<span class="co">#&gt;  9       9 2016-01-20 13:09:59 143550            M364111205          888</span>
<span class="co">#&gt; 10      10 2016-01-06 22:46:12 097298            M364111205          888</span>
<span class="co">#&gt; 11      11 2016-01-21 21:58:52 148533            M364111204          888</span>
<span class="co">#&gt; 12      12 2016-01-29 13:42:09 156205            AST215060001        888</span>
<span class="co">#&gt; 13      13 2016-01-20 13:04:16 143581            M364111107          888</span>
<span class="co">#&gt; 14      14 2016-01-26 01:07:40 148985            M364111209          889</span>
<span class="co">#&gt; 15      15 2016-01-29 12:27:41 167333            M364110707          888</span></code></pre></div>
<p>I also wrote an interface to allow the readers to filter the parquet files based on the file name. If I rename the parquet files based on the datetime of the file_id, this would enable the data scientists to filter to the time range very easily.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span><span class="va">dir_pqt_all</span>, <span class="st">'files'</span>, range<span class="op">=</span><span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4 × 5</span>
<span class="co">#&gt;   file_id start_date_time     uut_serial_number station_id   bond_count</span>
<span class="co">#&gt;     &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;             &lt;chr&gt;             &lt;int&gt;</span>
<span class="co">#&gt; 1       4 2016-01-10 05:39:49 108025            M364111210          888</span>
<span class="co">#&gt; 2       5 2016-01-06 17:09:08 097231            M364111107          888</span>
<span class="co">#&gt; 3       6 2016-01-21 07:25:25 144167            M364120804          888</span>
<span class="co">#&gt; 4       7 2016-01-11 17:52:28 103279            AST215060003        888</span></code></pre></div>
<p>Read in the bonds table:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_bonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span><span class="va">dir_pqt_all</span>, <span class="st">'bonds'</span><span class="op">)</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 17</span>
<span class="co">#&gt;   file_id bond_id process_program         zone_number wire_number bond_number</span>
<span class="co">#&gt;     &lt;int&gt;   &lt;int&gt; &lt;chr&gt;                         &lt;int&gt;       &lt;int&gt;       &lt;int&gt;</span>
<span class="co">#&gt; 1       1       1 Z06_TS_FP_KS_3600_1_1_4           6           1           1</span>
<span class="co">#&gt; 2       1       9 Z06_TS_FP_KS_3600_1_1_4           6           1           2</span>
<span class="co">#&gt; 3       1      17 Z06_TS_FP_KS_3600_1_1_4           6           2           1</span>
<span class="co">#&gt; 4       1      25 Z06_TS_FP_KS_3600_1_1_4           6           2           2</span>
<span class="co">#&gt; 5       1      33 Z06_TS_FP_KS_3600_1_1_4           6           3           1</span>
<span class="co">#&gt; 6       1      41 Z06_TS_FP_KS_3600_1_1_4           6           3           2</span>
<span class="co">#&gt; # … with 11 more variables: bond_group_id &lt;chr&gt;, date_time &lt;dttm&gt;,</span>
<span class="co">#&gt; #   wire_feed &lt;int&gt;, pull_test_status &lt;chr&gt;, program_rev &lt;chr&gt;,</span>
<span class="co">#&gt; #   cell_id_mod &lt;chr&gt;, brick_id_mod &lt;int&gt;, cell_polarity &lt;chr&gt;,</span>
<span class="co">#&gt; #   cp_id_mod &lt;chr&gt;, trace_sample_count &lt;int&gt;, rework_trigger_msg &lt;chr&gt;</span></code></pre></div>
</div>
<div id="parquet-save-out-by-group_id-with-model-ready-data" class="section level3">
<h3 class="hasAnchor">
<a href="#parquet-save-out-by-group_id-with-model-ready-data" class="anchor"></a>Parquet, save out by group_id with model-ready data</h3>
<p>If the DS team cares to model a specific group_id with samples, I partitioned the files by group_id in <code>output/pqt/grpid/&lt;group_id&gt;</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">dir_pqt_grpid</span><span class="op">)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/12mil_CP</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode_V313_V3_Minus</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/CP-Rev3-300(12)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Cathode-Rev3-300(12)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Cathode_V313_V2_Minus</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Ni-CP-Rev6-300(12)</span></code></pre></div>
<p>For example, you can see how some file_ids contained a <code>group_id</code> and others didn’t:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">dir_pqt_grpid</span>, recurse<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/12mil_CP</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/12mil_CP/part-00007.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/12mil_CP/part-00012.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)/part-00001.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)/part-00002.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)/part-00003.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)/part-00004.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)/part-00005.parquet</span>
<span class="co">#&gt; /home/rstudio/tesla/bonds/output/pqt/grpid/Anode-OPT3-300(12)/part-00006.parquet</span></code></pre></div>
<p>The data scientists can easily load in all the samples for a bond_id. This table replicates the metadata for each bond_id across each trace sample. This makes the data easily to model.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span>dir_root<span class="op">=</span><span class="va">dir_pqt_grpid</span>, tab<span class="op">=</span><span class="st">'12mil_CP'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span> 
<span class="co">#&gt; # A tibble: 20 × 24</span>
<span class="co">#&gt;    file_id bond_id process_program           zone_number wire_number bond_number</span>
<span class="co">#&gt;      &lt;int&gt;   &lt;int&gt; &lt;chr&gt;                           &lt;int&gt;       &lt;int&gt;       &lt;int&gt;</span>
<span class="co">#&gt;  1       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  2       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  3       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  4       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  5       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  6       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  7       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  8       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt;  9       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 10       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 11       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 12       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 13       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 14       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 15       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 16       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 17       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 18       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 19       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; 20       7       8 NTS_2000CELL_KS_ASTERION…          99           1           2</span>
<span class="co">#&gt; # … with 18 more variables: bond_group_id &lt;chr&gt;, date_time &lt;dttm&gt;,</span>
<span class="co">#&gt; #   wire_feed &lt;int&gt;, pull_test_status &lt;chr&gt;, program_rev &lt;chr&gt;,</span>
<span class="co">#&gt; #   cell_id_mod &lt;chr&gt;, brick_id_mod &lt;int&gt;, cell_polarity &lt;chr&gt;,</span>
<span class="co">#&gt; #   cp_id_mod &lt;chr&gt;, trace_sample_count &lt;int&gt;, SAMPLE &lt;int&gt;, DFRM &lt;dbl&gt;,</span>
<span class="co">#&gt; #   DRIV &lt;int&gt;, FREQ &lt;dbl&gt;, PHAS &lt;dbl&gt;, US &lt;int&gt;, VOLT &lt;int&gt;, ALCPT &lt;dbl&gt;</span></code></pre></div>
<details><summary>
Click for more data exploration
</summary><p>The following snippets explore the star schema data:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_bonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span>dir_root <span class="op">=</span> <span class="va">dir_pqt_all</span>, <span class="st">'bonds'</span><span class="op">)</span>
<span class="va">df_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span>dir_root <span class="op">=</span> <span class="va">dir_pqt_all</span>, <span class="st">'samples'</span><span class="op">)</span>

<span class="co"># 7 bond_group_ids</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">bond_group_id</span><span class="op">)</span><span class="op">)</span> 
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   `n_distinct(bond_group_id)`</span>
<span class="co">#&gt;                         &lt;int&gt;</span>
<span class="co">#&gt; 1                           7</span>

<span class="co"># sample: need to up/downsample</span>
<span class="co"># filter to the failed samples, save those in one file</span>
<span class="co"># extreme class imbalance</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">pull_test_status</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 2</span>
<span class="co">#&gt;   pull_test_status     n</span>
<span class="co">#&gt;   &lt;chr&gt;            &lt;int&gt;</span>
<span class="co">#&gt; 1 Fail                 1</span>
<span class="co">#&gt; 2 Pass             13320</span>

<span class="co"># there are 3548 bonds</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">bond_id</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   `n_distinct(bond_id)`</span>
<span class="co">#&gt;                   &lt;int&gt;</span>
<span class="co">#&gt; 1                  3548</span>

<span class="co"># there are up to 4600 samples per bond_id.</span>
<span class="va">df_samples</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">bond_id</span>, sort<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3,548 × 2</span>
<span class="co">#&gt;    bond_id     n</span>
<span class="co">#&gt;      &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1    1408  4645</span>
<span class="co">#&gt;  2    1628  4550</span>
<span class="co">#&gt;  3    1562  4295</span>
<span class="co">#&gt;  4    1342  4200</span>
<span class="co">#&gt;  5    1364  4200</span>
<span class="co">#&gt;  6    1386  4200</span>
<span class="co">#&gt;  7    1430  4200</span>
<span class="co">#&gt;  8    1452  4200</span>
<span class="co">#&gt;  9    1474  4200</span>
<span class="co">#&gt; 10    1496  4200</span>
<span class="co">#&gt; # … with 3,538 more rows</span>

<span class="co"># what's the relationship between bonds and samples?</span>
<span class="co"># multiple bond_ids</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">bond_group_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">bond_id</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 7 × 2</span>
<span class="co">#&gt;   bond_group_id         `n_distinct(bond_id)`</span>
<span class="co">#&gt;   &lt;chr&gt;                                 &lt;int&gt;</span>
<span class="co">#&gt; 1 12mil_CP                                888</span>
<span class="co">#&gt; 2 Anode_V313_V3_Minus                     433</span>
<span class="co">#&gt; 3 Anode-OPT3-300(12)                      758</span>
<span class="co">#&gt; 4 Cathode_V313_V2_Minus                   430</span>
<span class="co">#&gt; 5 Cathode-Rev3-300(12)                    690</span>
<span class="co">#&gt; 6 CP-Rev3-300(12)                        1247</span>
<span class="co">#&gt; 7 Ni-CP-Rev6-300(12)                      228</span>

<span class="co"># what's the primary key of the bonds table?</span>
<span class="co"># file_id, bond_id</span>
<span class="fu">count</span><span class="op">(</span><span class="va">df_bonds</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;       n</span>
<span class="co">#&gt;   &lt;int&gt;</span>
<span class="co">#&gt; 1 13321</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="va">file_id</span>, <span class="va">bond_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;       n</span>
<span class="co">#&gt;   &lt;int&gt;</span>
<span class="co">#&gt; 1 13321</span>

<span class="co"># what is the primary key of bonds table without file_id?</span>
<span class="co"># bond_id, bond_group_id, and date_time make a PK</span>
<span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="va">bond_id</span>, <span class="va">bond_group_id</span>, <span class="va">date_time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;       n</span>
<span class="co">#&gt;   &lt;int&gt;</span>
<span class="co">#&gt; 1 13321</span></code></pre></div>
</details>
</div>
</div>
<div id="build-an-ml-model" class="section level2">
<h2 class="hasAnchor">
<a href="#build-an-ml-model" class="anchor"></a>Build an ML model</h2>
<p>This section shows how a DS could model the data using the schema I’ve provided.</p>
<p>There are two simple ways to model the data:</p>
<ul>
<li>One model with bond_group_id as a feature</li>
<li>Multiple models (one per bond_group_id) - seems like what they’re doing is reading in data and then filtering for just a bond object. (I made this easier by saving out parquet files for that particular bond object)</li>
</ul>
<p>Upon inspecting the data, it appears there’s severe class imbalance (only one <code>Fail</code> per 13321 bonds). This data would be nearly impossible to model as is, so either we’d need to gather more data or would have to do up-sample the <code>samples</code> for the Fail status, downsample the <code>samples</code> for the Pass status, or some mixture of both.</p>
<p>Since only <code>Ni-CP-Rev6-300(12)</code> has a <code>Fail</code> test status, we’ll build a model on that group_id.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_bonds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pull_test_status</span> <span class="op">==</span> <span class="st">'Fail'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pull</span><span class="op">(</span><span class="va">bond_group_id</span><span class="op">)</span>
<span class="co">#&gt; [1] "Ni-CP-Rev6-300(12)"</span></code></pre></div>
<div id="load-in-model-data" class="section level3">
<h3 class="hasAnchor">
<a href="#load-in-model-data" class="anchor"></a>Load in model data</h3>
<p>Load data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_pqt.html">load_pqt</a></span><span class="op">(</span>dir_root <span class="op">=</span> <span class="va">dir_pqt_grpid</span>, tab<span class="op">=</span><span class="st">'Ni-CP-Rev6-300(12)'</span><span class="op">)</span></code></pre></div>
<p>There are 189 trace samples with label <code>pull_test_status=Fail</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_ni</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">pull_test_status</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 2</span>
<span class="co">#&gt; # Groups:   pull_test_status [2]</span>
<span class="co">#&gt;   pull_test_status      n</span>
<span class="co">#&gt;   &lt;chr&gt;             &lt;int&gt;</span>
<span class="co">#&gt; 1 Fail                189</span>
<span class="co">#&gt; 2 Pass             326403</span></code></pre></div>
</div>
<div id="model-data" class="section level3">
<h3 class="hasAnchor">
<a href="#model-data" class="anchor"></a>Model data</h3>
<p>I perform classification with <a href="https://www.kirenz.com/post/2021-02-17-r-classification-tidymodels/">tidymodels</a>, comparing both logistic regression (glm) with decision trees (xgboost). I query only a few numeric variables to keep things simple:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>
<span class="co">#&gt; Registered S3 method overwritten by 'tune':</span>
<span class="co">#&gt;   method                   from   </span>
<span class="co">#&gt;   required_pkgs.model_spec parsnip</span>
<span class="co">#&gt; ── Attaching packages ────────────────────────────────────── tidymodels 0.1.4 ──</span>
<span class="co">#&gt; ✓ broom        0.7.9      ✓ recipes      0.1.17</span>
<span class="co">#&gt; ✓ dials        0.0.10     ✓ rsample      0.1.0 </span>
<span class="co">#&gt; ✓ ggplot2      3.3.5      ✓ tibble       3.1.5 </span>
<span class="co">#&gt; ✓ infer        1.0.0      ✓ tune         0.1.6 </span>
<span class="co">#&gt; ✓ modeldata    0.1.1      ✓ workflows    0.2.4 </span>
<span class="co">#&gt; ✓ parsnip      0.1.7      ✓ workflowsets 0.1.0 </span>
<span class="co">#&gt; ✓ purrr        0.3.4      ✓ yardstick    0.0.8</span>
<span class="co">#&gt; ── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──</span>
<span class="co">#&gt; x glue::collapse() masks dplyr::collapse()</span>
<span class="co">#&gt; x purrr::discard() masks scales::discard()</span>
<span class="co">#&gt; x dplyr::filter()  masks stats::filter()</span>
<span class="co">#&gt; x recipes::fixed() masks stringr::fixed()</span>
<span class="co">#&gt; x purrr::flatten() masks jsonlite::flatten()</span>
<span class="co">#&gt; x dplyr::lag()     masks stats::lag()</span>
<span class="co">#&gt; x recipes::step()  masks stats::step()</span>
<span class="co">#&gt; • Use suppressPackageStartupMessages() to eliminate package startup messages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'xgboost'</span>
<span class="co">#&gt; The following object is masked from 'package:dplyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     slice</span>

<span class="co"># Convert pull_test_status to be 0-1</span>
<span class="va">df_model</span> <span class="op">&lt;-</span> <span class="va">df_ni</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    pull_test_status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">pull_test_status</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>
    <span class="va">pull_test_status</span>,
    <span class="va">zone_number</span>,
    <span class="va">wire_number</span>,
    <span class="va">DRIV</span>,
    <span class="va">PHAS</span>,
    <span class="va">VOLT</span><span class="op">)</span>

<span class="co"># explore distribution of the target variable</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_model</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pull_test_status</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; pull_test_status</span>
<span class="co">#&gt;   Fail   Pass </span>
<span class="co">#&gt;    189 326403</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="co"># Put 3/4 of the data into the training set </span>
<span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">df_model</span>, 
                           prop <span class="op">=</span> <span class="fl">.7</span>, 
                           strata <span class="op">=</span> <span class="va">pull_test_status</span><span class="op">)</span>

<span class="co"># Create dataframes for the two sets:</span>
<span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span> 
<span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span>

<span class="co"># specify target variable and training data</span>
<span class="co"># Downsample the data: https://themis.tidymodels.org/reference/step_downsample.html</span>
<span class="co"># recipes are for how data will be modeled and processed</span>
<span class="va">y_recipe</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">pull_test_status</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">themis</span><span class="fu">::</span><span class="fu"><a href="https://themis.tidymodels.org/reference/step_downsample.html">step_downsample</a></span><span class="op">(</span><span class="va">pull_test_status</span>, under_ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Registered S3 methods overwritten by 'themis':</span>
<span class="co">#&gt;   method                  from   </span>
<span class="co">#&gt;   bake.step_downsample    recipes</span>
<span class="co">#&gt;   bake.step_upsample      recipes</span>
<span class="co">#&gt;   prep.step_downsample    recipes</span>
<span class="co">#&gt;   prep.step_upsample      recipes</span>
<span class="co">#&gt;   tidy.step_downsample    recipes</span>
<span class="co">#&gt;   tidy.step_upsample      recipes</span>
<span class="co">#&gt;   tunable.step_downsample recipes</span>
<span class="co">#&gt;   tunable.step_upsample   recipes</span>

<span class="co"># ensure downsampling is done right: this proves i sampled</span>
<span class="co"># a small number of Pass variables</span>
<span class="va">y_recipe</span> <span class="op">%&gt;%</span>
  <span class="fu">prep</span><span class="op">(</span>training <span class="op">=</span> <span class="va">train_data</span>, retain <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">bake</span><span class="op">(</span>new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pull_test_status</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; pull_test_status</span>
<span class="co">#&gt; Fail Pass </span>
<span class="co">#&gt;  129  129</span>

<span class="co"># Specify model types</span>
<span class="va">mod_glm</span> <span class="op">&lt;-</span> <span class="fu">logistic_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">'glm'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">'classification'</span><span class="op">)</span>

<span class="co"># fit a model with downsampeld data</span>
<span class="va">downsampled_data</span> <span class="op">&lt;-</span> <span class="va">y_recipe</span> <span class="op">%&gt;%</span>
  <span class="fu">prep</span><span class="op">(</span>training <span class="op">=</span> <span class="va">train_data</span>, retain<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">bake</span><span class="op">(</span>new_data<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>

<span class="va">mod_glm</span> <span class="op">%&gt;%</span>
  <span class="fu">fit</span><span class="op">(</span><span class="va">pull_test_status</span> <span class="op">~</span> <span class="va">.</span>, data<span class="op">=</span><span class="va">downsampled_data</span><span class="op">)</span> 
<span class="co">#&gt; Warning: glm.fit: algorithm did not converge</span>
<span class="co">#&gt; Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="co">#&gt; parsnip model object</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fit time:  12ms </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:  stats::glm(formula = pull_test_status ~ ., family = stats::binomial, </span>
<span class="co">#&gt;     data = data)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)  zone_number  wire_number         DRIV         PHAS         VOLT  </span>
<span class="co">#&gt;    233.2565     -23.5407      -0.7302      -0.7556     -14.9039       6.3849  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Degrees of Freedom: 257 Total (i.e. Null);  252 Residual</span>
<span class="co">#&gt; Null Deviance:       357.7 </span>
<span class="co">#&gt; Residual Deviance: 1.184e-08     AIC: 12</span></code></pre></div>
<p>Compare GLM to XGB:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Specify model types</span>
<span class="va">mod_glm</span> <span class="op">&lt;-</span> <span class="fu">logistic_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">'glm'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">'classification'</span><span class="op">)</span>

<span class="va">mod_xgb</span> <span class="op">&lt;-</span> <span class="fu">boost_tree</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"xgboost"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> 

<span class="co"># Create the workflows</span>
<span class="va">wflow_glm</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">y_recipe</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">add_model</span><span class="op">(</span><span class="va">mod_glm</span><span class="op">)</span>

<span class="va">wflow_xgb</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">y_recipe</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">add_model</span><span class="op">(</span><span class="va">mod_xgb</span><span class="op">)</span>

<span class="co"># Define cross-validation</span>
<span class="va">cv_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">train_data</span>, v <span class="op">=</span> <span class="fl">5</span>, strata <span class="op">=</span> <span class="va">pull_test_status</span><span class="op">)</span> 

<span class="co"># Model the data, saving out the resutls</span>
<span class="va">results_glm</span> <span class="op">&lt;-</span> 
  <span class="va">wflow_glm</span> <span class="op">%&gt;%</span>
  <span class="fu">fit_resamples</span><span class="op">(</span>
      resamples <span class="op">=</span> <span class="va">cv_folds</span>, 
      metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span>
        <span class="va">recall</span>, <span class="va">precision</span>, <span class="va">f_meas</span>, 
        <span class="va">accuracy</span>, <span class="va">kap</span>,
        <span class="va">roc_auc</span>, <span class="va">sens</span>, <span class="va">spec</span><span class="op">)</span>,
      control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>
        save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      <span class="op">)</span> 
<span class="co">#&gt; ! Fold1: preprocessor 1/1, model 1/1: glm.fit: algorithm did not converge, glm.fi...</span>
<span class="co">#&gt; ! Fold2: preprocessor 1/1, model 1/1: glm.fit: algorithm did not converge, glm.fi...</span>
<span class="co">#&gt; ! Fold3: preprocessor 1/1, model 1/1: glm.fit: algorithm did not converge, glm.fi...</span>
<span class="co">#&gt; ! Fold4: preprocessor 1/1, model 1/1: glm.fit: algorithm did not converge, glm.fi...</span>
<span class="co">#&gt; ! Fold5: preprocessor 1/1, model 1/1: glm.fit: algorithm did not converge, glm.fi...</span>
<span class="co"># results_glm$.notes %&gt;% as.character()</span>

<span class="va">results_xgb</span> <span class="op">&lt;-</span> <span class="va">wflow_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">fit_resamples</span><span class="op">(</span>
      resamples <span class="op">=</span> <span class="va">cv_folds</span>, 
      metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span>
        <span class="va">recall</span>, <span class="va">precision</span>, <span class="va">f_meas</span>, 
        <span class="va">accuracy</span>, <span class="va">kap</span>,
        <span class="va">roc_auc</span>, <span class="va">sens</span>, <span class="va">spec</span><span class="op">)</span>,
      control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>
        save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      <span class="op">)</span> 
<span class="co"># results_xgb$.notes %&gt;% as.character()</span></code></pre></div>
<p>GLM/XGBoost results - both models seem comparable, but seem suspiciously good:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_glm</span> <span class="op">%&gt;%</span>
  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 8 × 6</span>
<span class="co">#&gt;   .metric   .estimator   mean     n std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 accuracy  binary     0.991      5 0.00271 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 f_meas    binary     0.136      5 0.0356  Preprocessor1_Model1</span>
<span class="co">#&gt; 3 kap       binary     0.135      5 0.0356  Preprocessor1_Model1</span>
<span class="co">#&gt; 4 precision binary     0.0751     5 0.0215  Preprocessor1_Model1</span>
<span class="co">#&gt; 5 recall    binary     0.986      5 0.0138  Preprocessor1_Model1</span>
<span class="co">#&gt; 6 roc_auc   binary     0.991      5 0.00694 Preprocessor1_Model1</span>
<span class="co">#&gt; 7 sens      binary     0.986      5 0.0138  Preprocessor1_Model1</span>
<span class="co">#&gt; 8 spec      binary     0.991      5 0.00271 Preprocessor1_Model1</span>

<span class="va">results_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 8 × 6</span>
<span class="co">#&gt;   .metric   .estimator   mean     n  std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 accuracy  binary     0.988      5 0.00146  Preprocessor1_Model1</span>
<span class="co">#&gt; 2 f_meas    binary     0.0920     5 0.0164   Preprocessor1_Model1</span>
<span class="co">#&gt; 3 kap       binary     0.0910     5 0.0164   Preprocessor1_Model1</span>
<span class="co">#&gt; 4 precision binary     0.0485     5 0.00906  Preprocessor1_Model1</span>
<span class="co">#&gt; 5 recall    binary     1          5 0        Preprocessor1_Model1</span>
<span class="co">#&gt; 6 roc_auc   binary     0.999      5 0.000184 Preprocessor1_Model1</span>
<span class="co">#&gt; 7 sens      binary     1          5 0        Preprocessor1_Model1</span>
<span class="co">#&gt; 8 spec      binary     0.988      5 0.00146  Preprocessor1_Model1</span></code></pre></div>
<p>Assess predictions - we notice a lot of overfitting in the model. There’s like a single feature driving everything (sign of feature leakage):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">preds_glm</span> <span class="op">&lt;-</span> <span class="va">results_glm</span> <span class="op">%&gt;%</span>
  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span>

<span class="va">preds_xgb</span> <span class="op">&lt;-</span> <span class="va">results_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span>

<span class="va">preds_glm</span> <span class="op">%&gt;%</span>
  <span class="fu">conf_mat</span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">.pred_class</span><span class="op">)</span>
<span class="co">#&gt;           Truth</span>
<span class="co">#&gt; Prediction   Fail   Pass</span>
<span class="co">#&gt;       Fail    127   2111</span>
<span class="co">#&gt;       Pass      2 226374</span>

<span class="co"># GBM predicts 100% of the failed classes (likely overfit)</span>
<span class="va">preds_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">conf_mat</span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">.pred_class</span><span class="op">)</span>
<span class="co">#&gt;           Truth</span>
<span class="co">#&gt; Prediction   Fail   Pass</span>
<span class="co">#&gt;       Fail    129   2745</span>
<span class="co">#&gt;       Pass      0 225740</span>

<span class="co"># Roc Curves is upside down (likely because of some bug with how</span>
<span class="co"># the target variable is labeled)</span>
<span class="va">preds_glm</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">.pred_Pass</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="Intro_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># ROC curve</span>
<span class="va">preds_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">roc_curve</span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">.pred_Pass</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="Intro_files/figure-html/unnamed-chunk-20-2.png" width="700"></p>
<p>Let’s see what features come up as important when we train on the full data and predict on a test set.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">last_fit_xgb</span> <span class="op">&lt;-</span> <span class="fu">last_fit</span><span class="op">(</span><span class="va">wflow_xgb</span>, 
                        split <span class="op">=</span> <span class="va">data_split</span>,
                        metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span>
                          <span class="va">recall</span>, <span class="va">precision</span>, <span class="va">f_meas</span>, 
                          <span class="va">accuracy</span>, <span class="va">kap</span>,
                          <span class="va">roc_auc</span>, <span class="va">sens</span>, <span class="va">spec</span><span class="op">)</span>
                        <span class="op">)</span>

<span class="co"># Prediction metrics look good</span>
<span class="va">last_fit_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 8 × 4</span>
<span class="co">#&gt;   .metric   .estimator .estimate .config             </span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 recall    binary        1      Preprocessor1_Model1</span>
<span class="co">#&gt; 2 precision binary        0.0408 Preprocessor1_Model1</span>
<span class="co">#&gt; 3 f_meas    binary        0.0783 Preprocessor1_Model1</span>
<span class="co">#&gt; 4 accuracy  binary        0.986  Preprocessor1_Model1</span>
<span class="co">#&gt; 5 kap       binary        0.0772 Preprocessor1_Model1</span>
<span class="co">#&gt; 6 sens      binary        1      Preprocessor1_Model1</span>
<span class="co">#&gt; 7 spec      binary        0.986  Preprocessor1_Model1</span>
<span class="co">#&gt; 8 roc_auc   binary        0.999  Preprocessor1_Model1</span>

<span class="co"># Explore </span>
<span class="va">last_fit_xgb</span> <span class="op">%&gt;%</span>
  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">conf_mat</span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">.pred_class</span><span class="op">)</span>
<span class="co">#&gt;           Truth</span>
<span class="co">#&gt; Prediction  Fail  Pass</span>
<span class="co">#&gt;       Fail    60  1412</span>
<span class="co">#&gt;       Pass     0 96506</span>

<span class="co"># Explore feature importance</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/koalaverse/vip/">vip</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'vip'</span>
<span class="co">#&gt; The following object is masked from 'package:utils':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     vi</span>
<span class="va">last_fit_xgb</span> <span class="op">%&gt;%</span> 
  <span class="fu">pluck</span><span class="op">(</span><span class="st">".workflow"</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>   
  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span><span class="op">(</span>num_features <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></code></pre></div>
<p><img src="Intro_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>Volt is the top predictor. There’s likely something about volt and wire number that’s driving “perfect” predictions. Let’s look at the distribution of VOLT compared to the target variable.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># downsampled data is the train data</span>
<span class="va">downsampled_data</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">pull_test_status</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">skimr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/skimr/reference/skim.html">skim</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<table class="table">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">Piped data</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">258</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">6</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">numeric</td>
<td align="left">5</td>
</tr>
<tr class="odd">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Group variables</td>
<td align="left">pull_test_status</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table">
<colgroup>
<col width="13%">
<col width="16%">
<col width="9%">
<col width="13%">
<col width="7%">
<col width="6%">
<col width="6%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="7%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="left">pull_test_status</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">zone_number</td>
<td align="left">Fail</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4.00</td>
<td align="right">0.00</td>
<td align="right">4.00</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">4.00</td>
<td align="left">▁▁▇▁▁</td>
</tr>
<tr class="even">
<td align="left">zone_number</td>
<td align="left">Pass</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2.56</td>
<td align="right">1.29</td>
<td align="right">1.00</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">4</td>
<td align="right">4.00</td>
<td align="left">▅▆▁▁▇</td>
</tr>
<tr class="odd">
<td align="left">wire_number</td>
<td align="left">Fail</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">72.00</td>
<td align="right">0.00</td>
<td align="right">72.00</td>
<td align="right">72</td>
<td align="right">72</td>
<td align="right">72</td>
<td align="right">72.00</td>
<td align="left">▁▁▇▁▁</td>
</tr>
<tr class="even">
<td align="left">wire_number</td>
<td align="left">Pass</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">37.67</td>
<td align="right">23.66</td>
<td align="right">1.00</td>
<td align="right">17</td>
<td align="right">35</td>
<td align="right">57</td>
<td align="right">81.00</td>
<td align="left">▇▆▅▆▅</td>
</tr>
<tr class="odd">
<td align="left">DRIV</td>
<td align="left">Fail</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1090.91</td>
<td align="right">132.66</td>
<td align="right">204.00</td>
<td align="right">1125</td>
<td align="right">1125</td>
<td align="right">1125</td>
<td align="right">1125.00</td>
<td align="left">▁▁▁▁▇</td>
</tr>
<tr class="even">
<td align="left">DRIV</td>
<td align="left">Pass</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1097.05</td>
<td align="right">118.58</td>
<td align="right">204.00</td>
<td align="right">1125</td>
<td align="right">1125</td>
<td align="right">1125</td>
<td align="right">1125.00</td>
<td align="left">▁▁▁▁▇</td>
</tr>
<tr class="odd">
<td align="left">PHAS</td>
<td align="left">Fail</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">-0.05</td>
<td align="right">0.18</td>
<td align="right">-0.49</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.49</td>
<td align="left">▁▁▇▁▁</td>
</tr>
<tr class="even">
<td align="left">PHAS</td>
<td align="left">Pass</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.01</td>
<td align="right">0.21</td>
<td align="right">-1.47</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.49</td>
<td align="left">▁▁▁▇▁</td>
</tr>
<tr class="odd">
<td align="left">VOLT</td>
<td align="left">Fail</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">107.75</td>
<td align="right">15.94</td>
<td align="right">6.00</td>
<td align="right">106</td>
<td align="right">113</td>
<td align="right">114</td>
<td align="right">116.00</td>
<td align="left">▁▁▁▁▇</td>
</tr>
<tr class="even">
<td align="left">VOLT</td>
<td align="left">Pass</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">122.57</td>
<td align="right">16.18</td>
<td align="right">7.00</td>
<td align="right">125</td>
<td align="right">125</td>
<td align="right">127</td>
<td align="right">131.00</td>
<td align="left">▁▁▁▁▇</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">downsampled_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">VOLT</span>, y <span class="op">=</span> <span class="va">pull_test_status</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="Intro_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># wire number is driving the prediction</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">downsampled_data</span>, 
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">wire_number</span>, y <span class="op">=</span> <span class="va">pull_test_status</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></code></pre></div>
<p><img src="Intro_files/figure-html/unnamed-chunk-22-2.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">downsampled_data</span>, 
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">wire_number</span>, y <span class="op">=</span> <span class="va">VOLT</span>, color<span class="op">=</span><span class="va">pull_test_status</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></code></pre></div>
<p><img src="Intro_files/figure-html/unnamed-chunk-22-3.png" width="700"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">downsampled_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">wire_number</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                 wire_number</span>
<span class="co">#&gt; pull_test_status   1   2   4   5   6   7   8   9  10  11  12  13  14  15  16</span>
<span class="co">#&gt;             Fail   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</span>
<span class="co">#&gt;             Pass   2   2   5   1   1   1   2   2   3   3   2   1   3   3   1</span>
<span class="co">#&gt;                 wire_number</span>
<span class="co">#&gt; pull_test_status  17  19  21  22  24  25  26  27  28  29  30  31  34  35  36</span>
<span class="co">#&gt;             Fail   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</span>
<span class="co">#&gt;             Pass   4   2   6   2   1   1   1   1   1   4   3   3   3   1   3</span>
<span class="co">#&gt;                 wire_number</span>
<span class="co">#&gt; pull_test_status  37  38  42  44  46  47  49  50  52  54  55  56  57  58  60</span>
<span class="co">#&gt;             Fail   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</span>
<span class="co">#&gt;             Pass   2   2   3   2   2   1   1   2   3   3   4   2   4   2   2</span>
<span class="co">#&gt;                 wire_number</span>
<span class="co">#&gt; pull_test_status  61  63  64  66  68  69  70  72  73  74  75  77  78  79  80</span>
<span class="co">#&gt;             Fail   0   0   0   0   0   0   0 129   0   0   0   0   0   0   0</span>
<span class="co">#&gt;             Pass   1   2   3   2   1   1   1   1   1   3   2   3   1   2   1</span>
<span class="co">#&gt;                 wire_number</span>
<span class="co">#&gt; pull_test_status  81</span>
<span class="co">#&gt;             Fail   0</span>
<span class="co">#&gt;             Pass   1</span>
<span class="va">downsampled_data</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">pull_test_status</span>, <span class="va">VOLT</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">VOLT</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from<span class="op">=</span><span class="va">pull_test_status</span>, values_from<span class="op">=</span><span class="va">n</span><span class="op">)</span> 
<span class="co">#&gt; # A tibble: 43 × 3</span>
<span class="co">#&gt; # Groups:   VOLT [43]</span>
<span class="co">#&gt;     VOLT  Pass  Fail</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1   131     2    NA</span>
<span class="co">#&gt;  2   130    22    NA</span>
<span class="co">#&gt;  3   129     8    NA</span>
<span class="co">#&gt;  4   127     8    NA</span>
<span class="co">#&gt;  5   126    17    NA</span>
<span class="co">#&gt;  6   125    40    NA</span>
<span class="co">#&gt;  7   124    13    NA</span>
<span class="co">#&gt;  8   123     2    NA</span>
<span class="co">#&gt;  9   122     2    NA</span>
<span class="co">#&gt; 10   121     2    NA</span>
<span class="co">#&gt; # … with 33 more rows</span></code></pre></div>
<p>Wire number 72 seems to be the only place where there are failures, where VOLT is in a range between 112 and 116.</p>
</div>
<div id="conclusion" class="section level3">
<h3 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h3>
<p>We built a model that has perfect recall (no false negatives) but poor precision (a lot of false positives).</p>
</div>
</div>
<div id="next-steps-for-data-model" class="section level2">
<h2 class="hasAnchor">
<a href="#next-steps-for-data-model" class="anchor"></a>Next Steps for Data Model</h2>
<p>Ideas:</p>
<ul>
<li>Since there’s such extreme class imbalance, I may consider partitioning the data by pass/fail. This would make it easier to access the failed samples and study them more closely.</li>
<li>Time series modeling: feature engineering across time.</li>
</ul>
<div id="future-enhancements" class="section level3">
<h3 class="hasAnchor">
<a href="#future-enhancements" class="anchor"></a>Future enhancements:</h3>
<ul>
<li>Parallelize the data processing. I tried doing this with the sqlite database, but was having connection issues. Paaralellizing the parquet write out would not have been an issue.</li>
<li>Since the file_ids aren’t chronological, we can update the parquet naming convention to be chronological using the start_date_time in the file_id. E.g., <code>data/pqt/12mil_CP/part-20211020_152030-00001.parquet</code>. This would allow the DS team to easily choose dates/times and read in that data. (I’d create a function similar to the <code>range</code> functionality, but filters parquet files between two dates.)</li>
</ul>
</div>
<div id="how-should-i-process-the-data-rpython" class="section level3">
<h3 class="hasAnchor">
<a href="#how-should-i-process-the-data-rpython" class="anchor"></a>How should I process the data? (R/Python/)</h3>
<p>I considered these alternatives for parsing json:</p>
<ul>
<li>Pandas</li>
<li>R: using <a href="https://themockup.blog/posts/2020-05-22-parsing-json-in-r-with-jsonlite/">jsonlite</a> or <a href="https://github.com/sailthru/tidyjson">tidyjson</a> packages</li>
<li><a href="https://docs.databricks.com/data/data-sources/read-json.html">Databricks spark</a></li>
<li><a href="https://spark.apache.org/docs/latest/sql-data-sources-json.html">Spark json</a></li>
<li><a href="https://spark.rstudio.com/reference/stream_read_json.html">sparklyr</a></li>
<li><a href="https://docs.dask.org/en/latest/generated/dask.dataframe.read_json.html">dask json</a></li>
</ul>
<p>Other solutions: - Looked at <a href="https://airbyte.io/etl-tools/airflow-alternative-airbyte">airbyte</a> and considered building an airbyte <a href="https://airbyte.io/connector-development-kit">connector</a>?</p>
<p>After considering the above, and playing around with a few common imports, I might try dask + prefect.</p>
</div>
<div id="how-would-i-set-up-a-workflow-orchestrator" class="section level3">
<h3 class="hasAnchor">
<a href="#how-would-i-set-up-a-workflow-orchestrator" class="anchor"></a>How would I set up a workflow orchestrator?</h3>
<p>Prefect works great with python’s dask. Airflow is fairly industry standard at this point. I would evaluate some of these tools for workflow and data pipeline orchestration:</p>
<ul>
<li><a href="https://www.prefect.io/">Prefect</a></li>
<li><a href="https://docs.metaflow.org/">MetaFlow</a></li>
<li><a href="https://airflow.apache.org/">Airflow</a></li>
<li><a href="https://www.pachyderm.com/">Pachyderm</a></li>
<li><a href="https://airbyte.io/etl-tools/airflow-alternative-airbyte">Airbyte vs. airflow</a></li>
<li>
<a href="https://dvc.org/doc/api-reference">dvc</a>: python data version control</li>
</ul>
</div>
<div id="how-would-i-enable-the-data-scientists-to-do-their-job-better" class="section level3">
<h3 class="hasAnchor">
<a href="#how-would-i-enable-the-data-scientists-to-do-their-job-better" class="anchor"></a>How would I enable the data scientists to do their job better?</h3>
<ul>
<li>In-SQL ML: <a href="https://mindsdb.com/">mindsdb</a> if we do the sql database approach, I might use airbyte to connect our sql database to mindsdb to do rapid automated machine learning.</li>
<li>
<a href="https://mlflow.org/">ML flow</a> for model experiment tracking.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bryan Whiting.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
